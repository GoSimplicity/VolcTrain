-- 数据集表
CREATE TABLE vt_datasets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(128) NOT NULL COMMENT '数据集名称',
    display_name VARCHAR(256) COMMENT '显示名称',
    description TEXT COMMENT '数据集描述',
    dataset_type ENUM(
        'image',
        'text',
        'audio',
        'video',
        'tabular',
        'time_series',
        'graph',
        'mixed'
    ) NOT NULL COMMENT '数据集类型',
    format VARCHAR(64) COMMENT '数据格式(json, csv, parquet等)',
    version VARCHAR(32) DEFAULT '1.0.0' COMMENT '版本号',
    total_size BIGINT DEFAULT 0 COMMENT '总大小(字节)',
    total_count INT DEFAULT 0 COMMENT '总记录数',
    train_count INT DEFAULT 0 COMMENT '训练集数量',
    val_count INT DEFAULT 0 COMMENT '验证集数量',
    test_count INT DEFAULT 0 COMMENT '测试集数量',
    storage_type ENUM('local', 's3', 'oss', 'hdfs', 'nfs', 'minio') DEFAULT 'local' COMMENT '存储类型',
    storage_path VARCHAR(512) COMMENT '存储路径',
    storage_config JSON COMMENT '存储配置',
    annotation_type ENUM(
        'classification',
        'detection',
        'segmentation',
        'regression',
        'nlp',
        'custom',
        'none'
    ) COMMENT '标注类型',
    label_config JSON COMMENT '标签配置',
    classes JSON COMMENT '类别信息',
    quality_score DECIMAL(3, 2) COMMENT '数据质量评分(0-1)',
    quality_report JSON COMMENT '质量报告',
    data_profile JSON COMMENT '数据剖析',
    status ENUM(
        'creating',
        'processing',
        'ready',
        'error',
        'archived'
    ) DEFAULT 'creating' COMMENT '数据集状态',
    visibility ENUM('public', 'private', 'workspace', 'shared') DEFAULT 'private' COMMENT '可见性',
    is_featured TINYINT(1) DEFAULT 0 COMMENT '是否推荐数据集',
    download_count INT DEFAULT 0 COMMENT '下载次数',
    view_count INT DEFAULT 0 COMMENT '查看次数',
    usage_count INT DEFAULT 0 COMMENT '使用次数',
    star_count INT DEFAULT 0 COMMENT '收藏次数',
    tags JSON COMMENT '标签',
    metadata JSON COMMENT '元数据',
    schema_config JSON COMMENT '数据结构配置',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at TIMESTAMP NULL COMMENT '软删除时间',
    INDEX idx_dataset_type (dataset_type),
    INDEX idx_format (format),
    INDEX idx_status (status),
    INDEX idx_visibility (visibility),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at),
    INDEX idx_is_featured (is_featured),
    INDEX idx_quality_score (quality_score),
    INDEX idx_type_visibility (dataset_type, visibility)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集表';
-- 数据集版本表
CREATE TABLE vt_dataset_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dataset_id BIGINT NOT NULL COMMENT '数据集ID',
    version VARCHAR(32) NOT NULL COMMENT '版本号',
    version_name VARCHAR(128) COMMENT '版本名称',
    description TEXT COMMENT '版本描述',
    change_log TEXT COMMENT '变更日志',
    parent_version_id BIGINT COMMENT '父版本ID',
    total_size BIGINT DEFAULT 0 COMMENT '总大小(字节)',
    total_count INT DEFAULT 0 COMMENT '总记录数',
    train_count INT DEFAULT 0 COMMENT '训练集数量',
    val_count INT DEFAULT 0 COMMENT '验证集数量',
    test_count INT DEFAULT 0 COMMENT '测试集数量',
    storage_path VARCHAR(512) COMMENT '存储路径',
    storage_config JSON COMMENT '存储配置',
    checksum VARCHAR(128) COMMENT '数据校验和',
    split_config JSON COMMENT '数据分割配置',
    transform_config JSON COMMENT '数据转换配置',
    preprocessing_config JSON COMMENT '预处理配置',
    status ENUM(
        'creating',
        'processing',
        'ready',
        'error',
        'deprecated'
    ) DEFAULT 'creating' COMMENT '版本状态',
    is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认版本',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_dataset_version (dataset_id, version),
    INDEX idx_dataset_id (dataset_id),
    INDEX idx_version (version),
    INDEX idx_status (status),
    INDEX idx_is_default (is_default),
    INDEX idx_created_at (created_at),
    INDEX idx_parent_version_id (parent_version_id)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集版本表';
-- 数据集文件表
CREATE TABLE vt_dataset_files (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dataset_id BIGINT NOT NULL COMMENT '数据集ID',
    version_id BIGINT COMMENT '版本ID',
    file_id BIGINT NOT NULL COMMENT '文件ID',
    relative_path VARCHAR(512) NOT NULL COMMENT '相对路径',
    file_type VARCHAR(64) COMMENT '文件类型',
    split_type ENUM('train', 'val', 'test', 'all', 'unlabeled') DEFAULT 'all' COMMENT '数据分割类型',
    category VARCHAR(128) COMMENT '类别',
    annotation_status ENUM('unlabeled', 'labeled', 'verified', 'rejected') DEFAULT 'unlabeled' COMMENT '标注状态',
    annotation_data JSON COMMENT '标注数据',
    annotation_at TIMESTAMP NULL COMMENT '标注时间',
    process_status ENUM(
        'pending',
        'processing',
        'completed',
        'failed',
        'skipped'
    ) DEFAULT 'pending' COMMENT '处理状态',
    process_result JSON COMMENT '处理结果',
    error_message TEXT COMMENT '错误信息',
    quality_score DECIMAL(3, 2) COMMENT '质量评分',
    quality_issues JSON COMMENT '质量问题',
    metadata JSON COMMENT '文件元数据',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_dataset_file (dataset_id, file_id),
    INDEX idx_dataset_id (dataset_id),
    INDEX idx_version_id (version_id),
    INDEX idx_file_id (file_id),
    INDEX idx_split_type (split_type),
    INDEX idx_annotation_status (annotation_status),
    INDEX idx_process_status (process_status),
    INDEX idx_created_at (created_at)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集文件表';
-- 数据集关联关系表 (通用关联表，替代各种外键关系)
CREATE TABLE vt_dataset_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dataset_id BIGINT NOT NULL COMMENT '数据集ID',
    entity_type VARCHAR(64) NOT NULL COMMENT '实体类型(workspace, user, model, training_job等)',
    entity_id BIGINT NOT NULL COMMENT '实体ID',
    relation_type VARCHAR(64) NOT NULL COMMENT '关联类型(owner, creator, training_dataset, validation_dataset等)',
    workspace_id BIGINT COMMENT '所属工作空间ID',
    is_primary TINYINT(1) DEFAULT 0 COMMENT '是否主要关联',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status ENUM('active', 'inactive', 'pending', 'deleted') DEFAULT 'active' COMMENT '状态',
    metadata JSON COMMENT '元数据',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_dataset_entity_relation (
        dataset_id,
        entity_type,
        entity_id,
        relation_type
    ),
    INDEX idx_dataset_id (dataset_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_relation_type (relation_type),
    INDEX idx_workspace_id (workspace_id),
    INDEX idx_status (status),
    INDEX idx_entity_relation (entity_type, relation_type)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集关联关系表';
-- 数据集版本关联表 (版本与创建者的关联)
CREATE TABLE vt_dataset_version_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    version_id BIGINT NOT NULL COMMENT '版本ID',
    entity_type VARCHAR(64) NOT NULL COMMENT '实体类型(user等)',
    entity_id BIGINT NOT NULL COMMENT '实体ID',
    relation_type VARCHAR(64) NOT NULL COMMENT '关联类型(created_by等)',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_version_entity_relation (
        version_id,
        entity_type,
        entity_id,
        relation_type
    ),
    INDEX idx_version_id (version_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_relation_type (relation_type),
    INDEX idx_status (status)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集版本关联表';
-- 数据集文件标注关联表 (文件与标注人的关联)
CREATE TABLE vt_dataset_file_annotations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dataset_file_id BIGINT NOT NULL COMMENT '数据集文件ID',
    user_id BIGINT NOT NULL COMMENT '标注用户ID',
    annotation_type VARCHAR(64) DEFAULT 'primary' COMMENT '标注类型',
    annotation_status ENUM(
        'in_progress',
        'completed',
        'verified',
        'rejected'
    ) DEFAULT 'in_progress' COMMENT '标注状态',
    annotation_data JSON COMMENT '标注数据',
    annotation_time_seconds INT COMMENT '标注耗时(秒)',
    quality_score DECIMAL(3, 2) COMMENT '标注质量评分',
    review_comments TEXT COMMENT '审核意见',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_file_user_type (dataset_file_id, user_id, annotation_type),
    INDEX idx_dataset_file_id (dataset_file_id),
    INDEX idx_user_id (user_id),
    INDEX idx_annotation_status (annotation_status),
    INDEX idx_annotation_type (annotation_type),
    INDEX idx_created_at (created_at)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '数据集文件标注关联表';